<div ng-controller="query" style="height:100%">

	<div class="modal fade" id="deleteModal">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title">Delete query</h4>
		  </div>
		  <div class="modal-body">
			<p>Are you sure you want to delete this query?</p>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			<button type="button" class="btn btn-primary" data-dismiss="modal" ng-click="delete()">Delete query</button>
		  </div>
		</div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->

	<nav class="navbar title-bar">
	
		<span ng-show="!renameMode" class="navbar-brand title">
			<span ng-show="view=='queries'">
				<span ng-show="!editmode">{{query.id}}</span>
				<span ng-show="editmode" class="query-id" ng-click="renameMode=true" title="Click to rename this query">{{query.id}}</span> 
				<span class="query-type" title="The query type is '{{query.type}}'">[{{query.type}}]</span>
			</span>
			<span ng-show="view=='rest'"><span class="rest-method">{{query.method}}</span> {{query.path}}</span>
		</span>
		
		<form ng-show="renameMode" ng-submit="rename()" class="navbar-form navbar-left">
			<div class="form-group">
				<input type="text" class="form-control" placeholder="QueryID" ng-model="query.id" ng-blur="rename()" />
			</div>
			<div class="form-group">
				<input type="submit" class="form-control btn btn-primary" value="Rename" />
			</div>
			<div class="form-group">
				<button class="form-control btn btn-default">Cancel</button>
			</div>
		</form>
	
		<ul class="nav navbar-nav navbar-right">
			<li ng-class="" ng-show="tab=='edit'"><a ng-click="compile()"><span class="glyphicon glyphicon-fire"></span> Compile</a></li>
			<li ng-class="" ng-show="tab=='edit'"><a ng-click="save()"><span class="glyphicon glyphicon-save" ng-class="{saveNeeded: query.saveNeeded==true}"></span> Save</a></li>
			<li ng-class="{active: tab=='edit'}" ng-show="editmode"><a ng-click="setTab('edit');initEditor()"><span class="glyphicon glyphicon-pencil"></span> Edit</a></li>
			<li ng-class="{active: tab=='run'}" ng-show="query.runnable"><a ng-click="setTab('run')"><span class="glyphicon glyphicon-play-circle"></span> Run</a></li>
			<li ng-class="{active: tab=='doc'}" ng-show="query.runnable"><a ng-click="setTab('doc')"><span class="glyphicon glyphicon-info-sign"></span> Doc</a></li>
			<li ng-class="" ng-show="editmode"><a ng-click="" data-toggle="modal" data-target="#deleteModal"><span class="glyphicon glyphicon-trash"></span> Delete</a></li>
		</ul>
	 
	</nav>

	<div class="tab-content" ng-show="tab=='edit'" id="query-editor" ></div>
		
	<div class="tab-content padded scroll-panel" ng-show="tab=='run'">
	
		<form role="form" class="form-horizontal">
		
			<div class="form-group">
			</div>
			
			<div class="form-group">
				<label ng-show="view=='queries'" class="col-sm-2 control-label" for="input-query-term">query term</label>
				<label ng-show="view=='rest'"    class="col-sm-2 control-label" for="input-query-path">query path</label>
				<div ng-show="view=='queries'" class="col-sm-6">
					<input id="input-query-term" type="text" class="form-control" ng-model="queryTerm" ng-blur="updateParams()" required >
				</div>
				<div ng-show="view=='rest'" class="col-sm-6">
					<input id="input-query-path" type="text" class="form-control" ng-model="query.path" ng-blur="updateParams()" required >
				</div>
				<div class="col-sm-4">
					<button ng-click="run()" type="submit" class="btn btn-default">
						<span class="glyphicon glyphicon-play-circle"></span>
						Run
					</button>
					<button ng-click="updateParams()" type="submit" class="btn">
						Update Params
					</button>
				</div>
			</div>			
			
			<div ng-repeat="(paramID, param) in params" class="form-group">
				<div ng-show="view!='rest' || paramID!=query.defaultParam">
				<label class="col-sm-2 control-label" for="input-{{paramID}}">{{paramID}}</label>
				<div class="col-sm-4">
					<input  id="input-{{paramID}}" type="text" class="form-control" ng-model="params[paramID].value" placeholder="Enter value for this parameter"  >
				</div>
				<div class="col-sm-6">
					<!--
					<span ng-class="{label: true, 'label-info': param.expose=='public', 'label-primary': param.expose=='private'}">{{param.expose}}</span> 
					-->
					<span ng-repeat="type in param.type">
						<span class="label label-{{type}}">{{type}}</span>
					</span>
				</div>
				</div>
			</div>
			
			<div class="form-group">
				<div class="col-sm-2">
				</div>
				<div class="col-sm-7">
					<span class="label label-default">stats:</span>
					<span class="label label-default">{{nRows}}</span>
					<span class="label label-default">{{profiling.database}}</span>
					<span class="label label-default">{{profiling.query}}</span>
					<span class="label label-default">{{profiling._total}}</span>
				</div>
				<div class="col-sm-3">
					<span class="label label-info">{{status}}</span>
				</div>
			</div>			

		</form>
		
		<div ng-show="error" class="alert alert-danger">{{error}}</div>
		
		<pre>{{ output | json }}</pre>		
	
	</div>
	
	<div class="tab-content padded scroll-panel" ng-show="tab=='doc'">
	
		<p class="doc">
			<div class="line" ng-repeat="line in query.doc">{{line}}</div>
		</p>
		
		<p class="doc" ng-show="query.type=='nest'">
			This query is used as helper query for nesting one query into another.
		</p>

		<p class="doc" ng-show="query.type=='filter'">
			This query is meant to be used as filter using the colon notation <code>a:b</code>
		</p>
		
		<p class="doc" ng-show="query.type=='attach'">
			This query is meant to be used to attach extra data to another query using the plus notation <code>a+b</code>
		</p>
		
		<div ng-show="query.term">
			
			<h3>Alias</h3>
			
			<p>This query is an alias for</p>
			
			<code>{{query.term}}</code>
			
		</div>

		<h3>Parameters</h3>
		
		<p ng-show="numberOfParams() == 0">
			This query has no parameters
		</p>
		
		<table class="table table-striped table-condensed" ng-show="numberOfParams() > 0">
			<thead>
				<tr>
					<th>Name</th>
					<th>Type</th>
					<th>Default</th>
					<th>Details</th>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="(name, def) in params">
					<td>{{name}}</td>
					<td>
						<span ng-repeat="type in def.type">
							<span class="label label-{{type}}">{{type}}</span>
						</span>
					</td>
					<td>{{def.default_str}}</td>
					<td>{{def.doc}}</td>
				</tr>
			</tbody>
		</table>
		
		<h3>Child queries</h3>
		
		<p ng-show="query.children.length==0">
			This query has no child queries
		</p>
		
		<ul>
			<li ng-repeat="child in query.children"><a href="#/queries/{{child}}">{{child}}</a></li>
		</ul>
				
		<h3>Output</h3>
		
		<p ng-show="query.output == false">
			This query has no output
		</p>
		
		<div ng-show="query.output.rows == 'first' && query.output.columns == 'first'">
			<p>
				<span ng-repeat="(name, def) in query.output.fields">
					<span class="label label-{{def.type[0]}}">{{def.type[0]}}</span>
				</span>
			</p>
			
			<p>The query will return a single value.</p>
		</div>
		<div ng-show="query.output.rows == 'first' && query.output.columns == 'all'">
			<p><span class="label label-object">object</span> <code>{ .. }</code></p>
			<p>The query will return an object containing the fields as described below.</p>
		</div>
		<div ng-show="query.output.rows == 'all' && query.output.columns == 'first'">
			<p><span class="label label-array">array</span> <code>[ .., .., .. ]</code></p>
			<p>The query will return an array.</p>
		</div>
		<div ng-show="query.output.rows == 'all' && query.output.columns == 'all' && !query.output.key">
			<p><span class="label label-array">array</span> <code>[ { .. }, { .. }, { .. } ]</code></p>
			<p>The query will return an array of objects. Each object contains the fields as described below.</p>
		</div>
		<div ng-show="query.output.rows == 'all' && query.output.columns == 'all' && query.output.key">
			<p><span class="label label-object">object</span> <code>{ [{{query.output.key}}]: { .. }, [{{query.output.key}}]: { .. }, .. }</code></p>
			<p>The query will return an object of objects. The key will be the value of <code>{{query.output.key}}</code>.
			Each object contains the fields as described below.</p>
		</div>
		
		<div ng-show="query.output && (query.output.rows != 'first' || query.output.columns != 'first')">
		
		<script type="text/ng-template" id="output-fields.html">
		
		<table class="table table-striped table-condensed fields">
			<!--
			<thead>
				<tr>
					<th>Name</th>
					<th>Type</th>
				</tr>
			</thead>
			-->
			<tbody>
				<tr ng-repeat="field in fields">
					<td ng-show="field.fields" colspan="2">
						<a ng-click="field.showsub = !field.showsub" title="Show subfields">{{field.label}}</a>
						<div ng-show="field.showsub" class="subfields" ng-repeat="fields in [ field.fields ]" ng-include="'output-fields.html'"></div>
					</td>
					<td ng-show="!field.fields">
						{{field.label}}
					</td>
					<td ng-show="!field.fields" class="type">
						<span ng-repeat="type in field.type">
							<span class="label label-{{type}}">{{type}}</span>
						</span>
					</td>
				</tr>
			</tbody>
		</table>
		
		</script>		
		
		<div ng-repeat="fields in [ query.output.fields ]" ng-include="'output-fields.html'"></div>
	
	</div>
	
			
</div>
